# Проектная работа "Веб-ларек"

Прототип интернет-магазина Web-ларёк, в котором можно посмотреть товары, добавить товары в корзину и сделать заказ.

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
Деплой Production-сборки проекта

```
npm run deploy
```

## Архитектура приложения

Архитектура следует модели MVP и разделена на три основных слоя, соединённых брокером событий:
- Model - хранит состояние, инкапсулирует логику
- View - отрисовывает UI, реагирует на события пользователя
- Presenter - модифицирует данные, триггерит обновления 


### Баззовые классы

#### Класс EventEmitter
Универсальный брокер событий, который дает возможность подписывать на события.\
Основные методы, реализуемые классов описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `off` - отписка от события
- `emit` - инициализация события

### Слой данных

#### Класс CardsData
Класс отвечает за хранение данных карточек товаров, представленных в каталоге товаров. \
Конструктор класса принимает инстант брокера событий.

В полях класса хранятся следующие данные:
- `_cards: ICard[]` - массив объектов карточек
- `_preview: string | null` - id карточки, выбоанной для просмотра в модальном окне
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Также класс предоставляет набор геттеров и сеттеров для сохранения и получения данных из полей класса

#### Класс BasketModel
Класс отвечает за хранение данных товаров, добавленных в корзину. \
Конструктор класса принимает инстант брокера событий.

В полях класса хранятся следующие данные:
- `items: Map<string, number> = new Map()` - объект, хранящий пары ключей и значений: id товара и количество данного товара, добавленного в корзину.
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Базовый класс Component
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

#### Класс Card
Класс предназначен для отображения карточки, а именно для отображения наименования товара, описания, изображения товара, категории и цены.

Поля класса:
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий.
- `cardId: string` - айди конкретного товара;
- `cardTitle: HTMLElement` - элемент разметки отображающий наименование товара;
- `cardDescription: HTMLElement` - элемент разметки отображающий описание товара;
- `cardImage: HTMLImageElement` - элемент разметки отображающий изображение товара;
- `cardCategory: HTMLElement` - элемент разметки отображающий категорию товара;
- `cardPrice: HTMLElement` - элемент разметки отображающий цену товара;
- `cardData: ICard` - объект содержащий данные товара;

Методы класса:
- `render` - принимает в качестве сигнатуры данные товара для отображения. Метод предотвращает отприсовку карточки товара, если данные не определены и вызывает все необходимые сеттеры для установки значений для соответсвующих элементов разметки.

#### Класс CardsContainer
Класс предназначен для отрисовки контейнера для всех карточек товара.
Поле `catalog: HTMLElement[]` - содержит массив всех элементов разметки карточек товаров для отображения в каталоге.
Сеттер класса устанавливает для поля catalog элементы, передаваемые в качестве сигнатуры.

#### Класс BasketItem
Класс отображает данные одного товара, находящегося в корзине.

Поля класса:
- `itemIndex: HTMLSpanElement` - index товара (позиция товара в списке, начиная с единицы).
- `itemTitle: HTMLSpanElement` - элемент разметки, содержащий название товара;
- `itemPrice: HTMLSpanElement` - элемент разметки, содержащий цену товара;
- `deleteItemButton: HTMLButtonElement` - кнока, по клику на которую количество товара, к которму привязана кнопка уменьшается на 1, если количество становится 0, то такой товар убирается из корзины и не отображается в соответсвующем модальном окне;
- `itemData: Partial<ICard>` - содержит необходимую информацию о товаре для корректного отображения.\
Конструктор принимает темплейт разметки для отображения товара в модальном окне корзины и инстант брокера событий. В конструкторе при нажатии на кнопку удаления товара устанавливается событие `product:deleteFromBasket`, удаляющее единицу товара из корзины.
Класс содержит все необходимые сеттеры для установления значений для всех соответсвующих элементов разметки и метод render, который принимает данные товара, включая index и количество определенного товара в корзине.\
Метод render предовтращает рендер пустого объекта, отрисовывает index для каждого товара, обновляет количество добавленного товара, либо устанавливает в качестве значения для количетсва 1, если товар был добавлен в корзину впервые.


#### Класс Modal

Класс реализует модальное окно, принимая в конструкторе темплейт окна, которое нужно открыть, и инстант брокера событий. Содержит методы `open` и `close` для управления отображением модального окна. Устанавливает слущатели событий для закрытия модального окна по клику на соответсвующую кнопку и по клику вне модального окна.

Поля класса:
- `rootElement: HTMLElement` - корневой элемент модального окна, который является контейнером для других модальных окон.
- `contentElement: HTMLElement` - элемнт контента модального окна, который изменяется в зависимости от темплейта, передаваемого в конструкторе.
- `closeButton: HTMLButtonElement` - элемент кнопки, для закрытия модального окна.
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.
- `data?: T` - данные которые используются для отображения.

#### Класс CardModal
Класс расширяет класс `Modal`. Предназначен для реализации модального окна с просмотром карточки товара и возможности добавления его в корзину.

Поля класса содержат HTML элементы для корректного отображения товара (загаловок, описание, изображение, категория, цена), id товара, кнопка для добавления в корзину.
- `modalTitle`, `modalDescription`, `modalImage`, `modalCategory`, `modalPrice` - элементы отображения данных товара
- `addToBasketButton` - кнопка для доавбления товара в корзину, при клике создается событие `product:addToBasket`, которое передает id товара для последующего отображения его в корзине
- `cardId` - id просматриваемого товара.\
Класс предоставляет набор сеттеров, котоыре устанавливает все необходимые значения для элементов отображения товара.

#### Класс BasketModal
Класс расширяет класс `Modal`. Предназначен для реализации модального окна с просмотром корзины и добавленных в ее товаров.

Поля класса:
- `events: IEvents` - экземпляр класса EventEmitter` для инициации событий при изменении данных.
- `basketList: HTMLUListElement` - элемент разметки, содержащий элементы добавленных товаров.
- `basketTotalPriceElement: HTMLSpanElement` - элемент разметки, отображающий общую сумму заказа.
- `basketTotalPriceValue: number` - сумма заказа.
- `makeOrderButton: HTMLButtonElement` - кнопка, создающая событие `order:goToDetails` для перехода на этап ввода данных для заказа.
- `itemsInBasket: ICardItem[]` - содержит данные про все добавленные товары.
- `renderedItemsId: string[] = []` - содержит массив id добавленных товаров хотя бы 1 раз.
- `itemsDataCache: Map<string, ICardItem> = new Map()` - содержит пары ключений и значений: id товара и данные этого товара, если он добавлен хотя бы 1 раз.

Конструктор принимает темплейт разметки модального окна и и инстант брокера событий.

Класс содержит следующие методы для работы с отображением данных корзины:
- updateBasket - в качестве сигнатур принимает объект c парами id товара и количество конкретного добавленного товара и экземпляр класса AppApi. Алгоритм работы метода:
    1. Превращает `Map` в массив `Array<[id, amount]>` для дальнейшего обхода.  
    2. Если список пуст — сбрасывает итоговую цену в `0 синапсов` и блокирует кнопку "Оформить заказ".  
    3. Очищает счётчик `basketTotalPriceValue`, список отрисованных id (`renderedItemsId`) и DOM‑узел `<ul class="basket__list">`.  
    4. Проходит по каждой паре `[id, amount]`:
    - Кэш есть - берёт данные из `itemsDataCache` и вызывает `createBasketItem`.  
    - Кэша нет - запрашивает `api.getProductData(id)`, кладёт результат в кэш и только затем вызывает `createBasketItem`.  
    5. Инкрементирует `currentIndex`, чтобы пронумеровать позиции 1, 2, 3…

- createBasketItem - создает элемент добавленного товара в корзине, принимая в качестве сигнатур данные карточки, которые надо отобразить, index (позиция товара в списке, начиная с единицы) и количество данного товара в корзине. Алгорит работы метода:
    1. Обновляет / добавляет запись в `itemsDataCache` (`id → { …productData, amount }`), сохраняя факт последнего количества.
    2. Создаёт экземпляр `BasketItem`, клонируя HTML‑шаблон `#card‑basket`.
    3. Вызывает `basketItem.render({ …productData, index, amount })`, чтобы отрисовать название, цену, кнопку удалить и т.д.
    4. Добавляет DOM‑узел BasketItem в `<ul class="basket__list">`.  
    5. Запоминает `productData.id` в `renderedItemsId`, чтобы позже синхронизировать список.  
    6. При наличии `price` увеличивает `basketTotalPriceValue` на `price * amount` и обновляет `<span class="basket__price">`.

#### Класс OrderDetailsModal
Класс расширяет класс `Modal`. Предназначен для реализации модального окна с вводом данных заказа.

Поля класса:
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.
- `addressInput: HTMLInputElement` - элемент разметки, предназначенный для ввода адреса доствки.
- `paymentMethodButtons: NodeListOf<HTMLButtonElement>` - элементы разметки кнопок, для выбора одного из двух метода оплаты: "**Онлайн**"" или "**При получении**".
- `currentlySelectedButton: HTMLButtonElement | null = null` - кнопка, которая отвечает, какой метод оплаты сейчас выбран, по-умолчанию значение null;
- `orderButton: HTMLButtonElement` - кнопка, при клике на которую отрывается следующуу окно с вводом контактной информации пользователя;
- `errorFields: HTMLSpanElement` - элемент разметки, содержащая ошибки валидации формы;
- `items: ICard[]` - массив товаров в корзине;

Конструктор класса принимает темплейт разметки окна с вводом данных заказа и инстант брокера событий. Также устанавливается слушатель события на элемент ввода адреса, который вызывает ошибку, если поле ввода пустое и устанавливает `orderButton` атрибут disabled, в ином случае ошибка проподает, а кнопка `orderButton` становится доступной. При клике на кнопку `orderButton` создается объект с *методом оплаты*, *адресом*, *всех товаров из корзины*, далее инициируется событие `order:goToContacts` и передает ранее созданный объект.\

Приватные методы класса:
- `paymentButtonsStates` - добавляет для всех кнопок выбора способы оплаты событие, изменяющее стиль выбранной кнопки и по клику устанавливет `paymentMethod` в соотсветствии с нажатой кнопкой.
- `toggleButtonState` - изменяет состояние атрибута disabled у кнопки для перехода на следующую страницу.
- `showEmptyFieldError` - показывает ошибку, если поле ввода пустое.

#### Класс ContactsModal
Класс расширяет класс `Modal`. Предназначен для реализации модального окна с вводном контакной информации пользователя (*email*, *номер телеформа*)

Поля класса:
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.
- `emailInput: HTMLInputElement` - элемент разметки поля ввода электронной почты пользователя.
- `phoneNumberInput: HTMLInputElement` - элемент разметки поля ввода номера телефона пользователя.
- `submitButton: HTMLButtonElement;` - элемент разметки кнопки для отправки всех данных заказа (*товары*, *адрес*, *способ оплаты*, *email*, *номер телефона*)

Конструктор класса принимает темплейт разметки окна с вводом контакных данных пользователя и инстант брокера событий. В конструкторе устанавливается слушатель события `order:goToContacts`, при котором передаются данные о *товарах*, *email* и *номере телефона*. На `submitButton` устанавливается слушатель события по клику, при котором создается объект со всей информацией о заказе, и создается событие `order:submit`, передавая этот объект

Приватные методы класса:
- `validateForm` - проверяет поля ввода на валидность (поля не могут быть пустыми), а также проверяет содержит ли поле вовода почты символы "**@**" и "**.**" (точка)
- `validatePhoneNumber` - проверяет длину введенного номера телефона, предварительно убирая все нечисловые символы.

### Слой коммуникации

#### Класс AppApi
Содержит в себе лоигку отправки запросов. В конструктор передается базовый адрес сервера.

Методы класса:
- `getProducts` - возвращает массив данных всех товаров.
- `getProductData` - принимает в качестве сигнатуры id товара и возращает его данные. 

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*
- `card:selected` - изменение открываемой в модальном окне картинки карточки.
- `basket:changed` - изменени данных товаров, добавленных в корзину.
- `initialData:loaded` - загрузка карточек товаров в каталоге.

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `cardModal:opened` - событие, генерируемое при клике на карточку товара.
- `product:addToBasket` - событие, генерируемое при клике на кнопку добавления товара в корзину.
- `product:deleteFromBasket` - событие, генерируемое при клике на кнопку удаления товара из корзины.
- `basketModal:opened` - событие, генерируемое при клике на кнопку открытия корзины. 
- `order:goToDetails` - событие, генерируемое при клике на кнопку "*оформить*" в корзине.
- `order:goToContacts` - событие, генерируемое при клике на кнопку "*далее*" в модальном окне ввода данных доставки.
- `order:submit` - событие, генерируемое при клике на кнопку "*оплатить*" в модальном окне ввода контакных даннхы пользователя.
- `modal:closed` - событие, генерируемое при закрытии любого модального окна, либо по кнопке, либо по клику вне модального окна.

## Ссылка на репозиторий
https://github.com/Koblanofff/web-larek-frontend

## Ссылка на gh-pages проект
https://koblanofff.github.io/web-larek-frontend/